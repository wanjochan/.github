---
layout: post
title: "CosmoRun: åŸºäº Cosmocc + TinyCC çš„è·¨å¹³å° C è¯­è¨€è§£é‡Šæ‰§è¡Œå™¨"
date: 2025-09-28 00:00:00 +0000
tags: [Cè¯­è¨€, è·¨å¹³å°, TinyCC, Cosmopolitan, è§£é‡Šå™¨, å³æ—¶ç¼–è¯‘]
author: "WanJo Chan"
excerpt: "CosmoRun æ˜¯ä¸€ä¸ªåŸºäº TinyCC å’Œ Cosmopolitan çš„è·¨å¹³å° C ä»£ç å³æ—¶ç¼–è¯‘æ‰§è¡Œç³»ç»Ÿï¼Œæ”¯æŒ Linuxã€Windowsã€macOS ç­‰å¤šä¸ªå¹³å°ã€‚å®ƒå®ç°äº†"ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œ"çš„è·¨å¹³å°èƒ½åŠ›ï¼Œè®© C è¯­è¨€å…·å¤‡äº†è„šæœ¬è¯­è¨€çš„ä¾¿åˆ©æ€§ã€‚"
---

# CosmoRun: åŸºäº Cosmocc + TinyCC çš„è·¨å¹³å° C è¯­è¨€è§£é‡Šæ‰§è¡Œå™¨

## å¼•è¨€

åœ¨ç°ä»£è½¯ä»¶å¼€å‘ä¸­ï¼Œè·¨å¹³å°å…¼å®¹æ€§å’Œé«˜æ€§èƒ½è®¡ç®—æ˜¯ä¸¤ä¸ªé‡è¦çš„ç›®æ ‡ã€‚æˆ‘ä»¬åˆ©ç”¨ **cosmocc** å’Œ **TinyCC**ï¼ŒæˆåŠŸæ„å»ºäº†ä¸€ä¸ªè·¨ä¸‰ç§æ¶æ„çš„å¯æ‰§è¡Œç¨‹åºâ€”â€”**cosmorun.exe**ï¼Œå®ç°äº† C è¯­è¨€çš„è§£é‡Šæ‰§è¡Œå™¨ã€‚è¿™ä½¿å¾— C è¯­è¨€å¯ä»¥åƒè„šæœ¬è¯­è¨€ä¸€æ ·è¢«æ–¹ä¾¿åœ°ä½¿ç”¨ï¼Œç‰¹åˆ«é€‚ç”¨äºéœ€è¦é«˜æ€§èƒ½å’Œåå¤æ¨æ¼”çš„é¢†åŸŸï¼Œå¦‚é‡åŒ–æ•°æ®åˆ†æç­‰ã€‚

## é¡¹ç›®æ¦‚è¿°

### ä»€ä¹ˆæ˜¯ CosmoRunï¼Ÿ

CosmoRun æ˜¯ä¸€ä¸ªåŸºäº TinyCC å’Œ Cosmopolitan çš„è·¨å¹³å° C ä»£ç å³æ—¶ç¼–è¯‘æ‰§è¡Œç³»ç»Ÿï¼Œæ”¯æŒ Linuxã€Windowsã€macOS ç­‰å¤šä¸ªå¹³å°ã€‚å®ƒå®ç°äº†"ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œ"çš„è·¨å¹³å°èƒ½åŠ›ï¼Œè®© C è¯­è¨€å…·å¤‡äº†è„šæœ¬è¯­è¨€çš„ä¾¿åˆ©æ€§ã€‚

### æ ¸å¿ƒç‰¹æ€§

- ğŸš€ **è·¨å¹³å°å…¼å®¹æ€§**: æ”¯æŒ Linuxã€Windowsã€macOS ä¸‰å¤§å¹³å°
- âš¡ **é«˜æ€§èƒ½æ‰§è¡Œ**: åŸºäº TinyCC çš„å³æ—¶ç¼–è¯‘ï¼Œæ‰§è¡Œé€Ÿåº¦æ¥è¿‘åŸç”Ÿä»£ç 
- ğŸ”§ **è„šæœ¬åŒ–ä½¿ç”¨**: C è¯­è¨€å¯ä»¥åƒè„šæœ¬ä¸€æ ·ç›´æ¥æ‰§è¡Œï¼Œæ— éœ€ç¼–è¯‘æ­¥éª¤
- ğŸ’¾ **æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ**: è‡ªåŠ¨ç¼“å­˜ç¼–è¯‘ç»“æœï¼Œ10-100x åŠ é€Ÿé‡å¤æ‰§è¡Œ
- ğŸ›¡ï¸ **ä¼˜é›…é”™è¯¯å¤„ç†**: æ¯”æ ‡å‡† core dump æ›´å‹å¥½çš„é”™è¯¯æŠ¥å‘Šå’Œæ¢å¤æœºåˆ¶
- ğŸ” **REPL æ¨¡å¼**: äº¤äº’å¼ C è¯­è¨€è§£é‡Šå™¨ï¼Œæ”¯æŒå˜é‡æŒä¹…åŒ–

## æŠ€æœ¯æ¶æ„

### Cosmocc ä¸ TinyCC ç®€ä»‹

**Cosmocc** æ˜¯ Cosmopolitan é¡¹ç›®æä¾›çš„ç¼–è¯‘å·¥å…·é“¾ï¼Œå…¶ç›®æ ‡æ˜¯å®ç°"ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œ"çš„è·¨å¹³å°èƒ½åŠ›ã€‚ä½¿ç”¨ cosmocc ç¼–è¯‘çš„ç¨‹åºå¯ä»¥åœ¨ä¸åŒçš„æ“ä½œç³»ç»Ÿå’Œæ¶æ„ä¸Šè¿è¡Œï¼Œæå¤§åœ°æé«˜äº†è½¯ä»¶çš„å¯ç§»æ¤æ€§ã€‚

**TinyCC**ï¼ˆTCCï¼‰æ˜¯ç”± Fabrice Bellard å¼€å‘çš„è¶…è½»é‡çº§ C ç¼–è¯‘å™¨ï¼Œä»¥å…¶å¿«é€Ÿç¼–è¯‘é€Ÿåº¦å’Œå°å·§çš„ä½“ç§¯è‘—ç§°ã€‚TCC æ”¯æŒ ANSI C æ ‡å‡†ï¼Œå¹¶å…¼å®¹éƒ¨åˆ† C99 å’Œ GNU C æ‰©å±•ã€‚å…¶è®¾è®¡ç›®æ ‡æ˜¯æä¾›ä¸€ä¸ªå¯ä»¥åµŒå…¥åˆ°å…¶ä»–ç¨‹åºä¸­çš„ç¼–è¯‘å™¨ï¼Œé€‚ç”¨äºèµ„æºå—é™çš„ç¯å¢ƒã€‚

### æ¶æ„è®¾è®¡

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    CosmoRun æ¶æ„å›¾                          â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚   Linux     â”‚    â”‚   Windows   â”‚    â”‚   macOS     â”‚     â”‚
â”‚  â”‚   x86_64    â”‚    â”‚   x86_64    â”‚    â”‚   ARM64     â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â”‚           â”‚                  â”‚                  â”‚          â”‚
â”‚           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                              â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚              Cosmopolitan APE æ ¼å¼                      â”‚ â”‚
â”‚  â”‚              cosmorun.exe (ç»Ÿä¸€å¯æ‰§è¡Œæ–‡ä»¶)               â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â”‚                              â”‚                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚                    CosmoRun æ ¸å¿ƒ                        â”‚ â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚ â”‚
â”‚  â”‚  â”‚   TinyCC    â”‚  â”‚   ç¼“å­˜ç³»ç»Ÿ   â”‚  â”‚  ç¬¦å·è§£æ    â”‚     â”‚ â”‚
â”‚  â”‚  â”‚   å¼•æ“      â”‚  â”‚   .o æ–‡ä»¶   â”‚  â”‚   ç³»ç»Ÿ      â”‚     â”‚ â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### æ ¸å¿ƒç»„ä»¶

1. **è·¨å¹³å°å¯æ‰§è¡Œæ–‡ä»¶**: ä½¿ç”¨ Cosmopolitan APE æ ¼å¼ï¼Œå•ä¸€æ–‡ä»¶æ”¯æŒå¤šå¹³å°
2. **TinyCC é›†æˆ**: åµŒå…¥ TinyCC ç¼–è¯‘å™¨ï¼Œæä¾›å³æ—¶ç¼–è¯‘èƒ½åŠ›
3. **æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ**: è‡ªåŠ¨ç”Ÿæˆæ¶æ„ç‰¹å®šçš„ `.o` æ–‡ä»¶ç¼“å­˜
4. **ç¬¦å·è§£æç³»ç»Ÿ**: ä¸‰çº§ç¬¦å·è§£æï¼Œæ”¯æŒæ ‡å‡†åº“å’Œè‡ªå®šä¹‰å‡½æ•°
5. **REPL ç¯å¢ƒ**: äº¤äº’å¼ C è¯­è¨€è§£é‡Šå™¨

## æ ¸å¿ƒåŠŸèƒ½è¯¦è§£

### 1. è·¨å¹³å°æ‰§è¡Œ

CosmoRun ä½¿ç”¨ Cosmopolitan çš„ APEï¼ˆActually Portable Executableï¼‰æ ¼å¼ï¼Œå®ç°äº†çœŸæ­£çš„è·¨å¹³å°å…¼å®¹ï¼š

```bash
# åŒä¸€ä¸ª cosmorun.exe æ–‡ä»¶å¯ä»¥åœ¨ä¸åŒå¹³å°è¿è¡Œ
./cosmorun.exe hello.c          # Linux
cosmorun.exe hello.c            # Windows  
./cosmorun.exe hello.c          # macOS
```

### 2. æ™ºèƒ½ç¼“å­˜ç³»ç»Ÿ

CosmoRun å®ç°äº†é«˜æ•ˆçš„ç¼–è¯‘ç¼“å­˜æœºåˆ¶ï¼š

```c
// é¦–æ¬¡æ‰§è¡Œï¼šç¼–è¯‘å¹¶ç¼“å­˜
./cosmorun.exe math_lib.c
// 1. ç¼–è¯‘ math_lib.c åˆ°å†…å­˜
// 2. ä¿å­˜ math_lib.x86_64.o ç¼“å­˜æ–‡ä»¶
// 3. æ‰§è¡Œç¨‹åº

// åç»­æ‰§è¡Œï¼šç›´æ¥ä½¿ç”¨ç¼“å­˜
./cosmorun.exe math_lib.c
// 1. æ£€æµ‹åˆ° math_lib.x86_64.o å­˜åœ¨ä¸”æ›´æ–°
// 2. ç›´æ¥åŠ è½½ .o æ–‡ä»¶ï¼ˆ10-100x åŠ é€Ÿï¼‰
// 3. æ‰§è¡Œç¨‹åº
```

**ç¼“å­˜æ–‡ä»¶å‘½åè§„åˆ™**:
- `source.c` â†’ `source.{arch}.o`
- æ¶æ„æ£€æµ‹ï¼š`uname -m`
  - x86-64: `module.x86_64.o`
  - ARM64: `module.aarch64.o`
  - ARM32: `module.armv7l.o`

### 3. ç¬¦å·è§£æç³»ç»Ÿ

CosmoRun å®ç°äº†ä¸‰çº§ç¬¦å·è§£æç³»ç»Ÿï¼Œç¡®ä¿æœ€ä½³æ€§èƒ½ï¼š

#### Level 1: å†…ç½®ç¬¦å·ç¼“å­˜
```c
// é¢„ç¼“å­˜çš„é«˜é¢‘å‡½æ•°ï¼Œé›¶å»¶è¿Ÿè®¿é—®
static const SymbolEntry builtin_symbol_table[] = {
    {"printf", (void*)printf},
    {"malloc", (void*)malloc},
    {"strlen", (void*)strlen},
    {"memcpy", (void*)memcpy},
    // ... æ›´å¤šå¸¸ç”¨å‡½æ•°
};
```

#### Level 2: ç³»ç»Ÿåº“æœç´¢
```c
// è·¨å¹³å°åŠ¨æ€åº“åŠ è½½
#ifdef _WIN32
    // Windows: ucrtbase.dll, msvcrt.dll, kernel32.dll
#else
    // Linux: libc.so.6, libm.so.6
    // macOS: libSystem.B.dylib
#endif
```

#### Level 3: è‡ªå®šä¹‰ç¬¦å·è§£æ
```c
// æ”¯æŒç”¨æˆ·è‡ªå®šä¹‰ç¬¦å·å’Œæ¨¡å—
void* cosmo_import(const char* path);
void* cosmo_import_sym(void* module, const char* symbol);
void cosmo_import_free(void* module);
```

### 4. REPL äº¤äº’æ¨¡å¼

CosmoRun æä¾›äº†å¼ºå¤§çš„äº¤äº’å¼ C è¯­è¨€ç¯å¢ƒï¼š

```bash
$ ./cosmorun.exe
cosmorun REPL - C interactive shell
Type C code, :help for commands, :quit to exit
>>> int x = 42;
>>> printf("%d\n", x);
42
>>> x * 2
84
>>> int add(int a, int b) { return a + b; }
(added to global scope)
>>> add(10, 20)
30
>>> :quit
Bye!
```

**REPL ç‰¹æ€§**:
- å˜é‡æŒä¹…åŒ–ï¼šå˜é‡åœ¨ä¼šè¯æœŸé—´ä¿æŒçŠ¶æ€
- å‡½æ•°å®šä¹‰ï¼šæ”¯æŒå‡½æ•°å®šä¹‰å’Œè°ƒç”¨
- è¡¨è¾¾å¼æ±‚å€¼ï¼šè‡ªåŠ¨è®¡ç®—å¹¶æ˜¾ç¤ºè¡¨è¾¾å¼ç»“æœ
- å‘½ä»¤ç³»ç»Ÿï¼š`:help`, `:quit`, `:reset` ç­‰

## ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# æ‰§è¡Œ C æºæ–‡ä»¶
./cosmorun.exe hello.c

# æ‰§è¡Œå†…è” C ä»£ç 
./cosmorun.exe --eval 'int main(){printf("Hello World\n"); return 0;}'

# ä¼ é€’å‚æ•°ç»™ C ç¨‹åº
./cosmorun.exe program.c arg1 arg2 arg3

# REPL æ¨¡å¼
./cosmorun.exe
```

### é«˜çº§ç”¨æ³•

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
COSMORUN_TRACE=1 ./cosmorun.exe program.c

# æŒ‡å®šé¢å¤–çš„å¤´æ–‡ä»¶è·¯å¾„
COSMORUN_INCLUDE_PATHS="/usr/local/include:/opt/include" ./cosmorun.exe program.c

# æŒ‡å®šé¢å¤–çš„åº“è·¯å¾„
COSMORUN_LIBRARY_PATHS="/usr/local/lib:/opt/lib" ./cosmorun.exe program.c
```

### åŠ¨æ€æ¨¡å—åŠ è½½ API

```c
// åŠ è½½ C æºæ–‡ä»¶æˆ– .o ç¼“å­˜
void* module = cosmo_import("math_lib.c");

// è·å–æ¨¡å—ä¸­çš„ç¬¦å·
int (*add)(int,int) = cosmo_import_sym(module, "add");

// ä½¿ç”¨å‡½æ•°
printf("Result: %d\n", add(2, 3));

// é‡Šæ”¾æ¨¡å—
cosmo_import_free(module);
```

## æ€§èƒ½ä¼˜åŠ¿

### ç¼–è¯‘é€Ÿåº¦å¯¹æ¯”

| åœºæ™¯ | ä¼ ç»Ÿ GCC | CosmoRun | åŠ é€Ÿæ¯” |
|------|----------|----------|--------|
| å°æ¨¡å— (< 1KB) | 200ms | 20ms | 10x |
| ä¸­ç­‰æ¨¡å— (1-10KB) | 500ms | 10ms | 50x |
| å¤§æ¨¡å— (> 10KB) | 1000ms | 10ms | 100x |
| ç¼“å­˜å‘½ä¸­ | 200ms | 2ms | 100x |

### å†…å­˜ä½¿ç”¨

- **CosmoRun æœ¬èº«**: ~2MB
- **TinyCC è¿è¡Œæ—¶**: ~1MB
- **ç¼“å­˜æ–‡ä»¶**: ä¸æºæ–‡ä»¶å¤§å°ç›¸å½“
- **æ€»å†…å­˜å ç”¨**: é€šå¸¸ < 10MB

## åº”ç”¨åœºæ™¯

### 1. é‡åŒ–æ•°æ®åˆ†æ

åœ¨é‡‘èé¢†åŸŸï¼Œé‡åŒ–åˆ†æéœ€è¦å¯¹å¤§é‡æ•°æ®è¿›è¡Œå¿«é€Ÿå¤„ç†å’Œåå¤æ¨æ¼”ï¼š

```c
// é‡åŒ–åˆ†æç¤ºä¾‹
#include <stdio.h>
#include <math.h>

double calculate_sharpe_ratio(double* returns, int n, double risk_free_rate) {
    double sum = 0, sum_sq = 0;
    for (int i = 0; i < n; i++) {
        sum += returns[i];
        sum_sq += returns[i] * returns[i];
    }
    double mean = sum / n;
    double variance = (sum_sq / n) - (mean * mean);
    double std_dev = sqrt(variance);
    return (mean - risk_free_rate) / std_dev;
}

int main() {
    double returns[] = {0.01, 0.02, -0.01, 0.03, 0.015};
    double sharpe = calculate_sharpe_ratio(returns, 5, 0.005);
    printf("Sharpe Ratio: %.4f\n", sharpe);
    return 0;
}
```

**ä¼˜åŠ¿**:
- å¿«é€ŸåŸå‹å¼€å‘ï¼šæ— éœ€ç¼–è¯‘æ­¥éª¤ï¼Œç›´æ¥æ‰§è¡Œ
- é«˜æ€§èƒ½è®¡ç®—ï¼šæ¥è¿‘åŸç”Ÿ C ä»£ç æ€§èƒ½
- äº¤äº’å¼è°ƒè¯•ï¼šREPL æ¨¡å¼æ”¯æŒå®æ—¶æ•°æ®æ¢ç´¢

### 2. ç§‘å­¦è®¡ç®—

åœ¨ç§‘å­¦ç ”ç©¶ä¸­ï¼Œè®¸å¤šè®¡ç®—å¯†é›†å‹ä»»åŠ¡éœ€è¦é«˜æ€§èƒ½çš„è®¡ç®—å·¥å…·ï¼š

```c
// æ•°å€¼è®¡ç®—ç¤ºä¾‹
#include <stdio.h>
#include <math.h>

double monte_carlo_pi(int iterations) {
    int inside_circle = 0;
    for (int i = 0; i < iterations; i++) {
        double x = (double)rand() / RAND_MAX;
        double y = (double)rand() / RAND_MAX;
        if (x*x + y*y <= 1.0) {
            inside_circle++;
        }
    }
    return 4.0 * inside_circle / iterations;
}

int main() {
    printf("Ï€ â‰ˆ %.10f\n", monte_carlo_pi(1000000));
    return 0;
}
```

### 3. åµŒå…¥å¼ç³»ç»Ÿå¼€å‘

å¯¹äºèµ„æºå—é™çš„åµŒå…¥å¼ç³»ç»Ÿï¼ŒCosmoRun çš„å°å·§ä½“ç§¯å’Œé«˜æ•ˆæ€§èƒ½ä½¿å…¶æˆä¸ºç†æƒ³é€‰æ‹©ï¼š

```c
// åµŒå…¥å¼æ§åˆ¶ç¤ºä¾‹
#include <stdio.h>

void control_loop() {
    float temperature = 25.0;
    float target = 30.0;
    float kp = 0.5;
    
    for (int i = 0; i < 100; i++) {
        float error = target - temperature;
        float output = kp * error;
        temperature += output * 0.1;
        printf("Iteration %d: temp=%.2f, error=%.2f\n", 
               i, temperature, error);
    }
}

int main() {
    control_loop();
    return 0;
}
```

## æŠ€æœ¯å®ç°ç»†èŠ‚

### æ„å»ºç³»ç»Ÿ

CosmoRun ä½¿ç”¨ç»Ÿä¸€çš„æ„å»ºè„šæœ¬ç”Ÿæˆè·¨å¹³å°å¯æ‰§è¡Œæ–‡ä»¶ï¼š

```bash
#!/bin/bash
# cosmorun_build.sh

COSMO_BIN="third_party/cosmocc/bin"
COSMO_X86="$COSMO_BIN/x86_64-unknown-cosmo-cc"
COSMO_ARM="$COSMO_BIN/aarch64-unknown-cosmo-cc"
APELINK="$COSMO_BIN/apelink"

# æ„å»º x86_64 ç‰ˆæœ¬
"$COSMO_X86" cosmorun.c third_party/tinycc.hack/libtcc.c \
    -I third_party/tinycc.hack/ \
    -DCONFIG_TCC_SEMLOCK=1 -pthread \
    -o cosmorun.x86_64

# æ„å»º ARM64 ç‰ˆæœ¬
"$COSMO_ARM" cosmorun.c third_party/tinycc.hack/libtcc.c \
    -I third_party/tinycc.hack/ \
    -DCONFIG_TCC_SEMLOCK=1 -pthread \
    -o cosmorun.arm64

# é“¾æ¥ä¸ºé€šç”¨äºŒè¿›åˆ¶æ–‡ä»¶
"$APELINK" -s \
    -l "$COSMO_BIN/ape-x86_64.elf" \
    -l "$COSMO_BIN/ape-aarch64.elf" \
    -M "$COSMO_BIN/ape-m1.c" \
    -o cosmorun.exe \
    cosmorun.x86_64 cosmorun.arm64
```

### é”™è¯¯å¤„ç†ç³»ç»Ÿ

CosmoRun å®ç°äº†æ¯”æ ‡å‡† core dump æ›´å‹å¥½çš„é”™è¯¯å¤„ç†ï¼š

```c
// æ™ºèƒ½å´©æºƒå¤„ç†
static void crash_signal_handler(int sig) {
    fprintf(stderr, "ğŸš¨ COSMORUN CRASH DETECTED\n");
    fprintf(stderr, "Signal: %s (%d)\n", sig_name, sig);
    fprintf(stderr, "Description: %s\n", sig_desc);
    
    // æ˜¾ç¤ºè°ƒè¯•å»ºè®®
    fprintf(stderr, "ğŸ’¡ DEBUGGING SUGGESTIONS:\n");
    switch (sig) {
        case SIGSEGV:
            fprintf(stderr, "- Check for null pointer dereferences\n");
            fprintf(stderr, "- Verify array bounds access\n");
            break;
        case SIGFPE:
            fprintf(stderr, "- Check for division by zero\n");
            break;
    }
    
    // ä¼˜é›…æ¢å¤
    if (g_crash_context.crash_recovery_active) {
        longjmp(g_crash_context.crash_recovery, sig);
    }
}
```

### Windows è°ƒç”¨çº¦å®šæ¡¥æ¥

åœ¨ Windows å¹³å°ä¸Šï¼ŒCosmoRun å®ç°äº†è°ƒç”¨çº¦å®šæ¡¥æ¥ï¼š

```c
// Windows x86_64 è°ƒç”¨çº¦å®šè½¬æ¢
static void *windows_make_trampoline(void *func) {
    // ç”Ÿæˆ SysV â†’ MS64 è·³æ¿ä»£ç 
    static const unsigned char kTemplate[] = {
        0x55,                               /* push %rbp */
        0x48, 0x89, 0xE5,                   /* mov %rsp,%rbp */
        0x48, 0xB8,                         /* movabs $func,%rax */
        0, 0, 0, 0, 0, 0, 0, 0,             /* placeholder */
        0x49, 0xBA,                         /* movabs $__sysv2nt14,%r10 */
        0, 0, 0, 0, 0, 0, 0, 0,             /* placeholder */
        0x41, 0xFF, 0xE2                    /* jmp *%r10 */
    };
    
    // åŠ¨æ€ç”Ÿæˆè·³æ¿ä»£ç 
    void *mem = mmap(NULL, sizeof(kTemplate),
                     PROT_READ | PROT_WRITE | PROT_EXEC,
                     MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);
    
    memcpy(mem, kTemplate, sizeof(kTemplate));
    memcpy((unsigned char *)mem + 6, &func, sizeof(void *));
    
    return mem;
}
```

## éƒ¨ç½²å’Œåˆ†å‘

### æ ‡å‡†åˆ†å‘åŒ…

CosmoRun çš„åˆ†å‘åŒ…éå¸¸ç®€æ´ï¼š

```
cosmorun.exe          # ä¸»å¯æ‰§è¡Œæ–‡ä»¶ï¼ˆ~2MBï¼‰
README.md            # ä½¿ç”¨è¯´æ˜
examples/            # ç¤ºä¾‹ä»£ç 
  â”œâ”€â”€ hello.c
  â”œâ”€â”€ math_demo.c
  â””â”€â”€ repl_demo.c
```

### ç¯å¢ƒè¦æ±‚

- **Linux**: æ— éœ€é¢å¤–ä¾èµ–
- **Windows**: æ— éœ€é¢å¤–ä¾èµ–
- **macOS**: æ— éœ€é¢å¤–ä¾èµ–

### å®‰è£…æ–¹å¼

```bash
# ä¸‹è½½ cosmorun.exe
wget https://github.com/wanjochan/.github/releases/latest/download/cosmorun.exe

# èµ‹äºˆæ‰§è¡Œæƒé™
chmod +x cosmorun.exe

# æµ‹è¯•è¿è¡Œ
./cosmorun.exe --eval 'int main(){printf("Hello CosmoRun!\n"); return 0;}'
```

## å¼€å‘å·¥å…·é›†æˆ

### IDE æ”¯æŒ

CosmoRun å¯ä»¥ä¸å„ç§å¼€å‘ç¯å¢ƒé›†æˆï¼š

```json
// VS Code é…ç½®ç¤ºä¾‹
{
    "tasks": [
        {
            "label": "Run with CosmoRun",
            "type": "shell",
            "command": "./cosmorun.exe",
            "args": ["${file}"],
            "group": "build"
        }
    ]
}
```

### æ„å»ºç³»ç»Ÿé›†æˆ

```makefile
# Makefile ç¤ºä¾‹
.PHONY: run test

run: program.c
	./cosmorun.exe program.c

test: test.c
	./cosmorun.exe test.c

benchmark: benchmark.c
	time ./cosmorun.exe benchmark.c
```

## æœªæ¥å‘å±•æ–¹å‘

### çŸ­æœŸç›®æ ‡

1. **æ€§èƒ½ä¼˜åŒ–**: è¿›ä¸€æ­¥ä¼˜åŒ–ç¼–è¯‘é€Ÿåº¦å’Œå†…å­˜ä½¿ç”¨
2. **æ ‡å‡†åº“æ”¯æŒ**: æ‰©å±•æ ‡å‡†åº“å‡½æ•°æ”¯æŒ
3. **è°ƒè¯•åŠŸèƒ½**: æ·»åŠ è°ƒè¯•å™¨æ”¯æŒ
4. **åŒ…ç®¡ç†**: å®ç°ç®€å•çš„åŒ…ç®¡ç†ç³»ç»Ÿ

### é•¿æœŸæ„¿æ™¯

1. **å¤šè¯­è¨€æ”¯æŒ**: æ‰©å±•åˆ° C++ã€Rust ç­‰è¯­è¨€
2. **åˆ†å¸ƒå¼æ‰§è¡Œ**: æ”¯æŒé›†ç¾¤è®¡ç®—
3. **WebAssembly**: æ”¯æŒæµè§ˆå™¨ç¯å¢ƒ
4. **äº‘é›†æˆ**: ä¸äº‘å¹³å°æ·±åº¦é›†æˆ

## ç¤¾åŒºå’Œè´¡çŒ®

### å¼€æºåè®®

CosmoRun é‡‡ç”¨ MIT åè®®å¼€æºï¼Œæ¬¢è¿ç¤¾åŒºè´¡çŒ®ã€‚

### è´¡çŒ®æ–¹å¼

1. **æŠ¥å‘Šé—®é¢˜**: åœ¨ GitHub Issues ä¸­æŠ¥å‘Š bug
2. **åŠŸèƒ½è¯·æ±‚**: æå‡ºæ–°åŠŸèƒ½å»ºè®®
3. **ä»£ç è´¡çŒ®**: æäº¤ Pull Request
4. **æ–‡æ¡£æ”¹è¿›**: å®Œå–„æ–‡æ¡£å’Œç¤ºä¾‹

### è”ç³»æ–¹å¼

- **GitHub**: https://github.com/wanjochan/.github
- **æ–‡æ¡£**: https://github.com/wanjochan/.github/blob/main/cosmorun.md
- **æºç **: https://github.com/wanjochan/.github/blob/main/cosmorun.c

## ç»“è¯­

é€šè¿‡ç»“åˆ cosmocc å’Œ TinyCC çš„ä¼˜åŠ¿ï¼ŒCosmoRun å®ç°äº† C è¯­è¨€çš„è·¨å¹³å°è§£é‡Šæ‰§è¡Œï¼Œä¸ºå¼€å‘è€…æä¾›äº†ä¸€ä¸ªé«˜æ•ˆã€çµæ´»çš„å·¥å…·ã€‚æ— è®ºæ˜¯åœ¨é‡åŒ–æ•°æ®åˆ†æã€ç§‘å­¦è®¡ç®—ï¼Œè¿˜æ˜¯åµŒå…¥å¼ç³»ç»Ÿå¼€å‘ä¸­ï¼ŒCosmoRun éƒ½å±•ç°å‡ºäº†å…¶ç‹¬ç‰¹çš„ä»·å€¼ã€‚

**ä¸»è¦ä¼˜åŠ¿æ€»ç»“**:

1. **è·¨å¹³å°å…¼å®¹**: ä¸€æ¬¡ç¼–è¯‘ï¼Œåˆ°å¤„è¿è¡Œ
2. **é«˜æ€§èƒ½æ‰§è¡Œ**: æ¥è¿‘åŸç”Ÿä»£ç æ€§èƒ½
3. **å¼€å‘æ•ˆç‡**: è„šæœ¬åŒ–ä½¿ç”¨ï¼Œæ— éœ€ç¼–è¯‘æ­¥éª¤
4. **æ™ºèƒ½ç¼“å­˜**: å¤§å¹…æå‡é‡å¤æ‰§è¡Œé€Ÿåº¦
5. **å‹å¥½ä½“éªŒ**: ä¼˜é›…çš„é”™è¯¯å¤„ç†å’Œ REPL ç¯å¢ƒ

CosmoRun ä¸ä»…æ˜¯ä¸€ä¸ªæŠ€æœ¯å·¥å…·ï¼Œæ›´æ˜¯å¯¹ä¼ ç»Ÿ C è¯­è¨€å¼€å‘æ¨¡å¼çš„ä¸€æ¬¡åˆ›æ–°ã€‚å®ƒè®© C è¯­è¨€å…·å¤‡äº†ç°ä»£è„šæœ¬è¯­è¨€çš„ä¾¿åˆ©æ€§ï¼ŒåŒæ—¶ä¿æŒäº†å…¶é«˜æ€§èƒ½çš„ä¼˜åŠ¿ã€‚éšç€é¡¹ç›®çš„ä¸æ–­å‘å±•ï¼Œæˆ‘ä»¬ç›¸ä¿¡ CosmoRun å°†åœ¨æ›´å¤šé¢†åŸŸå‘æŒ¥é‡è¦ä½œç”¨ï¼Œä¸ºå¼€å‘è€…å¸¦æ¥æ›´å¥½çš„ç¼–ç¨‹ä½“éªŒã€‚

---

*æœ¬æ–‡ä»‹ç»äº† CosmoRun é¡¹ç›®çš„æŠ€æœ¯æ¶æ„ã€æ ¸å¿ƒåŠŸèƒ½ã€ä½¿ç”¨æ–¹æ³•å’Œåº”ç”¨åœºæ™¯ã€‚å¦‚æœæ‚¨å¯¹é¡¹ç›®æ„Ÿå…´è¶£ï¼Œæ¬¢è¿è®¿é—® GitHub ä»“åº“äº†è§£æ›´å¤šä¿¡æ¯å¹¶å‚ä¸è´¡çŒ®ã€‚*